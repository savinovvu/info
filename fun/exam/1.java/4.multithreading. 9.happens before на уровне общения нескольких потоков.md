**Happens-before** в Java — это набор правил, определяющих гарантии видимости изменений и порядка выполнения операций между потоками. Если операция A *happens-before* операция B, то все изменения памяти, сделанные в A, видны потоку, выполняющему B. Вот ключевые правила на уровне многопоточного общения:

---

### **Основные правила happens-before**
1. **Монитор (блокировки)**
    - **Вход в `synchronized`-блок** happens-before **любым последующим входом** в тот же монитор.
    - Пример:
      ```java
      // Поток 1:
      synchronized (lock) {
          x = 1; // Запись
      }
      // Поток 2:
      synchronized (lock) {
          System.out.println(x); // Гарантированно увидит 1
      }
      ```

2. **`volatile`-поля**
    - **Запись в `volatile`-переменную** happens-before **чтением** той же переменной.
    - Пример:
      ```java
      // Поток 1:
      volatile boolean flag = false;
      x = 42;
      flag = true; // Запись в volatile
 
      // Поток 2:
      if (flag) { // Чтение volatile
          System.out.println(x); // Гарантированно увидит 42
      }
      ```

3. **Запуск и завершение потоков**
    - **`thread.start()`** happens-before **первым действием** запущенного потока.
    - **Последнее действие потока** happens-before **`thread.join()`** или проверке завершения.
    - Пример:
      ```java
      // Поток 1:
      x = 10;
      thread.start(); // Запуск потока 2
 
      // Поток 2:
      public void run() {
          System.out.println(x); // Гарантированно увидит 10
      }
      ```

4. **Инициализация объектов**
    - **Завершение конструктора** happens-before **любым вызовом методов** объекта (включая статические инициализаторы).

5. **Передача через исключения**
    - **Запись в `catch`-блок** happens-before **обработкой исключения** в другом потоке.

---

### **Пример с `volatile` и без него**
Без `volatile` возможна **видимость устаревших данных**:
```java
// Поток 1:
x = 1; // Не-volatile
flag = true; // Не-volatile

// Поток 2:
while (!flag) {} // Может зациклиться или не увидеть x = 1
System.out.println(x); // Может вывести 0
```

С `volatile`:
```java
// Поток 1:
x = 1;
volatile boolean flag = true; // Гарантирует видимость x = 1

// Поток 2:
while (!flag) {}
System.out.println(x); // Всегда 1
```

---

### **Как это работает на практике?**
- **Компилятор/процессор** не может переупорядочивать операции нарушающие happens-before.
- **Кэши процессора** синхронизируются так, что изменения становятся видимыми.

---

### **Важные моменты**
1. **Неформальные гарантии**:
    - Если нет happens-before, JVM может переупорядочивать операции.
    - Используйте `synchronized`, `volatile`, `java.util.concurrent`, чтобы явно задавать порядок.

2. **`java.util.concurrent`**:
    - Классы вроде `ConcurrentHashMap`, `CountDownLatch`, `CyclicBarrier` строятся на этих правилах.

---

### **Итог**
Happens-before — это **не про временной порядок**, а про **гарантии видимости изменений**. Правильное использование механизмов синхронизации позволяет избежать гонок данных и обеспечить консистентность в многопоточных программах.